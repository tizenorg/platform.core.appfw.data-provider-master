#!/bin/sh

launch_provider()
{
	RETRY_COUNT=0
	while [ ! -f "/tmp/.stop.provider" ]; do
		# default method is "file"
		# available type: "shm", "pixmap", "file"
		DEBUG_PROVIDER="false" USE_SHM_FOR_LIVE_CONTENT="file" /usr/bin/data-provider-master
		let RETRY_COUNT=$RETRY_COUNT+1
		if [ $RETRY_COUNT -gt 5 ]; then
			echo "EXCEED THE MAXIMUM RETRY COUNT: $RETRY_COUNT (max 5)"
			break;
		fi
	done
	rm /tmp/.stop.provider
}

start ()
{
	rm /opt/share/live_magazine/*
	rm /opt/share/live_magazine/reader/*
	rm /tmp/.stop.provider
	launch_provider &
}

stop ()
{
	PID=$!
	if [ x"$PID" == x"" ]; then
		PID=`ls -l /proc/ | grep 'self ->' | awk '{print $11}'`
	fi

	touch /tmp/.stop.provider
	PID=`ps ax | grep 'data-provider-master' | grep -v "$PID" | grep -v "sh" | grep -v "grep" | grep -v "rpm" | grep -v "dlogutil" | awk '{print $1}'`
	if [ x"$PID" != x"" ]; then
		KIL=`kill -9 $PID 2>&1 > /dev/null`
		KIL_RET=$?
		if [ $KIL_RET -ne 0 ]; then
			echo "Data provider is already stopped ($KIL_RET)"
		fi
		sleep 1
	fi
}

case "$1" in
	start|"") start;;
	stop) stop;;
	restart) stop; start;;
esac

# End of a file
